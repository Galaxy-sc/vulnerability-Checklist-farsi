# 4. Bussiness Logic

1. قیمت اصلی محصول رو عوض کنید مثلا اگر هست 100 دلار تغییرش بدید به 50 دلار

2. قیمت اصلی محصول رو با ی عدد منفی عوض کنید مثلا بزارید -50 دلار

3. قیمت اصلی محصول رو به همراه منفی کردن عوض کنید مثلا +-120

4. قیمت رو با ضرب در 0.5 عوض کنید مثلا  100 * 0.5

5. تغییر دادن پروفایل :

برای مثال وقتی علی پروفایلش با id=1001 در دسترس هست اگر مقدار این id رو به 1089 یا عدد های دیگه تغییر بدید اطلاعات مابقی کاربران سایت مشاهده رو میتونید ببینید

مقدار 1001 رو به 1001` تغییر بدید تا sql injection پیدا کنید

نمیشه نتیجه گرفت که اپلیکیشن در برابر authorization بایپس اسیب پذیر باشه

با تغییر id از 1001 به 1089 تست نفوذگر میتونه پروفایل کیان به جای علی رو ببینه

6. سبد خرید

بزارید یک اپلیکیشن فروشگاه انلاین رو در نظر بگیریم که در اون مشتریان اقلامی رو به سبد خرید خودشون اضافه می کنند. این اپلیکیشن مشتریاشو به یک درگاه پرداخت امن می فرسته تا اونجا سفارش خودشونو ثبت کنند. برای تکمیل سفارش، مشتریان مجبور به پرداخت توسط کارت بانکی هستند. این سبد خرید اسیب پذیری Bussiness Logic داره. این امکان رو برای attacker فراهم میکنه که فرایند احراز هویت رو بایپس کنه و مستقیم وارد سبد خرید اپلیکیشن بشه و اقلام مورد نیازشو بدون پرداخت هزینه خرید کنه

7. بررسی قابلیت ها (Review Functionality)

بعضی از اپلیکیشن ها قابلیتی دارند که بازدید کننده برای نظر دادن یا کامت گزاشتن باید تایید یا همون وریفای بشه. امتحان کنید ببینیدمی تونید بدون خرید اون محصول، نظری رو به عنوان یک بازدید کننده تایید شده ارسال کنید.

بعضی از اپلیکیشن ها بهتون قابلیت امتیاز دادن میدن معمولا از 1 تا 5 میخان بهشون امتیاز بدید شما تلاش کنید 0 یا 6 یا چیزی که خارج از بازه ای که اونا براتون انتخاب کردن بدید

امتحان کنید ببینید ی کاربر میتونه چندین بار یک امتیاز رو برای ی محصول ثبت کنه. این ی endpoint جالب برای بررسی Race Conditions هست

امتحان کنید ببینید فیلد اپلود فایل به هر پسوندی اجازه میده, معمولا دیده میشه انجام اقدامات امنیتی این endpoint ها از دید دولوپر ها خارج میمونه

سعی کنید نظرات خودتو مثل بقیه کاربرا ارسال کنید.

سعی کنید CSRF رو روی این قابلیت پیاده کنید, معمولا توسط توکن ها محافظت نمیشن

8. قابلیت کد تخفیف (Coupon Code Functionality)

یک کد تخفیف رو چندبار وارد کنید ببینید اعمال میشه چندبار اون تخفیف

اگر کد تخفیف یک بار مصرف هست یا برای شخص خاصی هست, تست Race Condition رو امتحان کنید, این کد یک بار مصرف رو برای 2 حساب به صورت هم زمان اعمال کنید 

اسیب پذیری های Mass Assignment یا HTTP Parameter رو امتحان کنید و ببینید میتونید چندین کد تخفیف اضافه کنید در صورتی که اپلیکیشن فقط یک کد تخفیف از سمت کلاینت قبول میکنه

حملات ورودی ها رو انجام بدید مثل sql injecton یا XSS و…

سعی کنید با دستکاری ریکوئست سمت سرور, کدهای تخفیف رو روی محصولاتی اضافه کنید که شامل تخفیف نیستند.

9. سو استفاده از شارژ دلیوری (Delivery Charges Abuse)

سعی کنید مبلغ شارژ دلیوری مقدارشو به منفی تغییر بدید تا ببینید می شه مبلغ نهایی رو کم کرد یا نه.

با دستکاری پارامتر ها دلیوری رایگان رو امتحان کنید

Currency Arbitrage

10. با 1 ارز مثلا USD پرداخت کنید و سعی کنید به EUR مبلغتونو پس بگیرید (برگشت وجه بزنید). به دلیل تفاوت توی نرخ تبدیل، ممکنه بشه مبلغ بیشتری رو به دست بیارید

11. سو استفاده از قابلیت های پریمیوم (Premium Feature Abuse)

سعی کنید جاهایی رو یا endpoint های خاصیو که تحت حساب های کاربری پریمیوم هستند رو مرور کنید.

برای یک قابلیت پریمیوم هزینه کنید و اشتراک خودتونو کنسل کنید. اگر پولتونو پس دادن و اون قابلیت پریمیوم همچنان میشد استفاده کرد (حالا ممکنه قابلیت پریمیوم یک api مثلا بوده باشه که خیلی مستقیم بهتون داده باشن بدون اینکه بسنجن برای فلان اکانت فعال شده و بعدش غیر فعال بشه اینجور اگر خیلی مستقیم داده باشن حتی میشه به بقیه هم بدید یا بدون حساب خودتون ازش استفاده بکنید دیگ اصلا عالیه =)) )
بعضی از اپلیکیشن ها از مقدار های true یا false در ریکوئست یا ریسپانس هاشون برای تایید اینکه کاربر به قابلیت های پریمیوم دسترسی داره یا ن استفاده میکنن

سعی کنید از Match & Replace برپ استفاده کنید تا ببینید می تونید این مقادیر رو جایگزین کنید که هر موقع که اپلیکیشن رو مرور می کنید به قابلیت های پریمیوم دسترسی پیدا کنید

همیشه کوکی‌ها یا  لوکال استوریج (local storage) رو بررسی کنید تا ببینید متغیری بررسی می‌کنه که کاربر باید به قابلیت های پریمیوم دسترسی داشته باشد یا نه

12. سو استفاده از قابلیت برگشت وجه

یک محصول بخرید (مثلا اشتراک بگیرید) و درخواست بازگشت وجه کنید تا ببینید این قابلیت هنوز قابل دسترس هست یا نه

مورد 10 (Currency Arbitrage) رو امتحان کنید

سعی کنید چند ریکوئست برای کنسل کردن اشتراکتون (race conditions) ایجاد کنید تا ببینید میشه چندبار مبلغتونو پس بگیرید

1. Cart/Wishlist Abuse

یک محصول رو به سبد خرید اضافه کنید و از قسمت سبد خرید ببینید میتونید مقدارشو اضافه یا کم بکنید اگر میشه سعی کنید با کلیک کردن رو علامت - اون محصول رو کم کنید اگر بشه تعداد رو منفی یا صفر کرد و خرید انجام داد و محصول قابل استفاده بشه یا اگر بشه تعدادش رو با کلیک روی دکمه - منفی کرد و مبلغ نهایی منفی بشه و با اضافه کردن محصولات دیگه مبلغ نهایی رو روی 0 یا حداقل مبلغ نگه دارید و خرید بکنید و تمامی اون محصولات برای شما قابل استفاده بشه

محصولی رو بیش از مقدار موجودی اش اضافه کنید

ببینید وقتی که محصولی رو به علاقه مندی هاتون یا سبد خرید اضافه میکنید میشه به سبد خرید کاربرای دیگه هم اضافه کنید یا حذف کنید

1. Thread Comment Functionality

فرض کنید یک کاربر فقط یک بار می‌تونه نظر یا همون کامنت بزاره, race conditions رو اینجا امتحان کنید تا ببینید چندین نظر امکان‌پذیر هست یا نه

فرض کنید یک گزینه هست: نظر توسط کاربر تایید شده (یا بعضی از کاربرای خاص) سعی کنید پارامترهای مختلف رو دستکاری کنید تا ببینید می تونید این کار رو انجام بدید یا نه

سعی کنید نظراتی رو با جعل هویت بعضی از کاربرای دیگه ارسال کنید

15. دستکاری پارامتر (Parameter Tampering)

دستکاری پرداخت یا فیلدهای بحرانی برای دستکاری مقادیر اونها

افزودن چندین فیلد یا فیلدهای غیرمنتظره با سوء استفاده از HTTP Parameter Pollution & Mass Assignment

دستکاری ریسپانس برای بایپس محدودیت های خاص مثل 2FA

16. دستکاری پارامترها می تونه منجر به تغییر قیمت محصول بشه

[https://www.youtube.com/watch?v=3VMlV7j_yzg](https://www.youtube.com/watch?v=3VMlV7j_yzg)

17. دستکاری نتایج ازمون ها
سوالات ازمون رو جواب بدید تا قسمت نهایی که قرار هست نمره شما مشخص بشه و برای مثال مدرک اکادمیک بگیرید. به این صورت ممکنه سوالات درست فاش بشه برای مثال اگر داخل ریکوئست پارامتری بود که  1 = true  و خالی = false یا هرچیزی که مشخص کنه اون سوالات درست یا غلط هست حتی میتونید مرحله به مرحله که سوالات رو جواب میدید ریکوئست هارو چک بکنید

مراحل:

امتحان با هر جوابی به پایان برسونید

امتحان مجدد شروع بکنید

ریسپانس یا ریسپانس هایی که جواب ها داخلشون بودن رو به ترتیب در امتحان مجدد ارسال کنید

برای مثال: 

{"answers":{"503":"","504":"","505":"1","506":"","507":"","591":"1","592":"","593":"","594":"","595":"","596":"","1340":"1","1341":"","1342":"","1343":"","1344":"","1345":"","1351":"1","1352":"","1353":"","1354":"","1355":"","1356":"","1357":"","1358":"1","1359":"","1360":"","1361":"","1362":"","1363":"","1365":"1"}}

1. Authentication flags and privilege escalations at application layer

اپلیکیشن ها لیست های کنترل دسترسی (ACL) و مزیت خاص خودشونو دارند. احراز هویت (Authentication) قسمت مهم امنیت اپلیکیشن هست. یک کاربر احراز هویت شده به صفحات و ساختارهای داخلی که بعد از لاگین کردنش در نظر گرفته شده دسترسی داره. این امتیازاتو می شه توسط پایگاه داده، LDAP، فایل و غیره نگه داشت. اگر authorization ضعیف باشه، دستمونو  توی اسیب پذیری های احتمالی باز می کند. اگر این اسیب‌پذیری‌ها موقع تست شناسایی بشند، میتونید اکسپلویتشون کنید. این سو استفاده احتمالا شامل دسترسی به محتوای کاربر دیگه ای یا تبدیل شدن به یک کاربر سطح بالاتر (ادمین مثلا) با مجوزهای بیشتر که نتیجش اسیب بیشتری رسوندن هست.

نحوه آزمایش این نقص business logic:

ریکوئست و ریسپانس هارو ببینید

متود POST/GET ریکوئست ها نوعی پارامتر زوج name-value یا JSON ,XML یا Cookies دارن. باید name و value پارامتر انالیز بشه.

اگه نام پارامتر مشکوک باشه و نشان بده که ربطی به ACL/Permission داره، اون موقع هست که به یک تارگت تبدیل می شه.

موقعی که تارگت شناسایی شد، مرحله بعدی ارزیابی value هست، میشه اونو به صورت هگز، باینری، استرینگ و… انکد کرد. تستر باید سعی کنه با کمی فاز کردن انکد ها و value های مختلف بفهمه روی چی بیشتر حساس هست و روی چی حساسیت کمتری داره.

در این مورد، فاز کردن ممکن هست به یک رویکرد منطقی، تغییر الگوهای بیت یا فلگ های مجوز مانند 1 به 0 یا Y به N و… نیاز داشته باشد. ترکیبی از بروت فورس, نتیجه گیری حرفه ای, خلاقیت به کشف منطقش کمک میکنه. اگر با موفقیت این کارو بکنید میتونید اکسپلویتش کنید و سطح دسترسی خودتونو افزایش بدید یا authorization رو بایپس کنید.

1. دستکاری پارامترهای حیاتی و دسترسی به اطلاعات/محتوای غیرمجاز

معمولا HTTP ریکوئست های GET و POST دارای چندین پارامتر موقع ارسال به اپلیکیشن هستند. این پارامتر ها میتونن به صورت زوج های name-value یا JSON یا XML و… باشند. جالبه که این پارامتر هارو میشه دستکاری یا حدس زد و پیش بینی کرد. اگر منطق بیزینسی اپلیکیشن قبل از تایید یا همون ولیدیت کردن این پارامتر ها رو پردازش کنه میتونه منچر به information/content disclosure (افشای اطلاعات) بشه. این یکی دیگ از مشکلات business logic هست که به راحتی اکسپلویت میشه. چطور این نقص business logic رو تست کنیم:

ریکوئست و ریسپانس هارو ببینید

متود POST/GET ریکوئست ها نوعی پارامتر زوج name-value یا JSON ,XML یا Cookies دارن. باید name و value پارامتر انالیز بشه.

 سعی کنید value های موجود در ترافیک رو ببینید و در همه پارامتر ها به دنبال اعداد افزایشی و value هایی که قابل حدس زدن هستند باشید.

مقدار یا همون value این پارامتر هارو میشه تغییر داد و ممکنه به دسترسی های غیر مجاز یا مسیر ها و قابلیت هایی که برای شما نباید فعال باشه برسید.

1. Developer’s cookie tampering and business process/logic bypass

کوکی ها یک جزء ضروری برای حفظ وضعیت در HTTP هستند. تو خیلی از موارد دولوپر ها از session کوکی ها فقط استفاده نمی‌کنند, بلکه فقط با استفاده از متغییر های session داده هارو به صورت داخلی میسازند. دولوپر های اپلیکیشن کوکی های جدیدی رو روی جاهای مهم مرورگر ست میکنند که حفره هارو اشکار میکنه. بعد از اینکه منطق احراز هویت (authentication) چندین پارامتر رو بر اساس مشخصات کاربری ست کرد, دولوپر ها دو گزینه برای حفظ این اعتبارنامه ها در بین اپلیکیشن ها دارند. دولوپر ها می تونند پارامترهارو در متغیرهای session ست کنند یا کوکی هارو توی مرورگر با مقادیر مناسب ست کند. اگر اپلیکیشن دولوپر ها کوکی‌هارو ارسال کنند، ممکنه مهندسی معکوس شده باشند یا مقادیری داشته باشند که بشه حدس زد یا رمزگشایی کرد. میتونه امکان ی بایپس یا حفره منطقی ایجاد کنه. اگر یک attacker بتونه این حفره رو شناسایی کنه، میتونه به راحتی اکسپلویتش کنه. چطور این نقص business logic رو آزمایش کنیم:

ریکوئست و ریسپانس هارو ببینید

تمام کوکی های ارائه شده رو در طول جمع اوری اطلاعات انالیز کنید, بعضی از این کوکی ها توسط دولوپر ها تعریف میشند و session کوکی ها توسط سرور وب اپلیکیشن تعریف نشدند. مقادیر کوکی هارو به صورت ویژه ببینید, به دنبال افزایش مقادیر قابل حدس در همه کوکی ها باشید.

مقدار کوکی رو میشه تغییر داد و ممکن هست به دسترسی غیرمجاز یا logical escalation برسید

1. شناسایی پارامتر LDAP و دسترسی به زیرساخت های حیاتی (LDAP Parameter Identification and Critical Infrastructure Access)

امروزه LDAP در حال تبدیل شدن به یک جنبه مهم برای اپلیکیشن های بزرگ هست و ممکنه با "single sign on" نیز ادغام بشه. خیلی از ابزارهای لایه زیرساخت مثل Site Minder یا Load Balancer از LDAP برای authentication و authorization استفاده می کنند. پارامترهای LDAP میتونند اسیب پذیری business logic رو به دوش بکشند و میشه از اونها سوء استفاده کرد. فیلترینگ LDAP که در لایه بیزینس اپلیکیشن انجام میشه امکان logical injections روی اون پارامترهارو فراهم میکنه اگر اپلیکیشن اعتبار سنجی کافی نکنه LDAP injection و بایپس لایه بیزینس امکان پذیره

چطور این نقص business logic رو تست کنیم:

ریکوئست و ریسپانس هارو ببینید

متود POST/GET ریکوئست ها نوعی پارامتر زوج name-value یا JSON ,XML یا Cookies دارن. باید name و value پارامتر انالیز بشه

پارامترها و مقادیرشونو انالیز کنید, ON, CN, DN و… باشید. معمولاً این پارامترها با LDAP مرتبط هستند همچنین به دنبال پارامتر دریافت ایمیل یا یوزرنیم باشید, این پارامترها میتونند تارگت هایی برای اینده باشند

این پارامترهای تارگت رو میشه با "*" یا هر فیلتر خاص LDAP دیگه ای مثل OR, AND و.. دستکاری و تزریق کرد.

میتونه منجر به لاجیکال بایپس LDAP و افزایش دسترسی بشه

22. اکسپلویت کردن محدودیت های بیزینسی(Business Constraint Exploitation), منطق بیزینسی اپلیکیشن باید قاعده و محدودیت های مشخصی داشته باشه که برای یک اپلیکیشن بسیار حیاتی هست. اگر این محدودیت ها توسط attacker بایپس بشه میتونه اکسپلویتش کنه. فیلدهای کاربری که طراحی یا پیاده سازی ضعیفی دارند معمولا توسط این محدودیت های بیزینسی کنترل میشه. اگر منطق بیزینس متغییر هارو به‌عنوان مقادیر پنهان پردازش می‌کنه, به کشف و اکسپلویتیشن اسونش منجر میشه. در حین crawling و جمع اوری اطلاعات اپلیکیشن, میشه تمام این مقادیر مختلف و مکان های تزریق اونهارو فهرست کرد. مرور این فیلد های پنهان و درک بستر اونها راحت هست. اگر این بستر برای کنترل قوانین بیزینس مورد استفاده قرار گیرد, دستکاری این اطلاعات میتونه منجر به اسیب پذیری های business logic بشه.

چطور این نقص business logic رو تست کنیم:

ریکوئست و ریسپانس هارو ببینید

متود POST/GET ریکوئست ها نوعی پارامتر زوج name-value یا JSON ,XML یا Cookies دارن. باید name و value پارامتر انالیز بشه

پارامترهای پنهان و مقادیر اونهارو انالیز کنید. به دنبال نامیدن های خاص بیزینسی مثل انتقال پول، حداکثر محدودیت و غیره باشید. همه این پارامترها که محدودیت های بیزینسی رو دیکته می کنند میتونند به یک تارگت تبدیل شوند. 

این پارامترهای تارگت رو میشه دستکاری کرد و مقادیرشونو میشه تغییر داد. میشه از محدودیت بیزینسی اجتناب کرد و تراکنش غیرمجاز (unauthorized) رو تزریق کرد.

برای درک اسیب‌پذیری بای پس محدودیت بیزینسی، یک مثال ساده میزنم, وب سایتی رو در نظر بگیرید که اطلاعاتی در مورد نرم افزارهای برتر امنیت سایبری ارائه میده. کاربران ممکنه بتونند سه مقاله برترو به عنوان یک نسخه رایگان بخوانند, اما برای دسترسی به اطلاعات کامل باید یا پرداخت کنند یا اشتراک تهیه کنند.

حمله بایپس محدودیت بیزینسی سعی می کنه محدودیت های تعیین شده توسط اپلیکیشن رو برای دسترسی دوباره به اون اطلاعات دور بزنه(مثل موارد اشاره شده میتونه پارامتر هایی باشه که خارج از دید کاربرای معمولی قرار گرفته باشه ولی داخل ریکوئست ها و رسیپانس ها این مورد در معرض دید باشه). حتی اگر حمله نتونه به طور غیرقانونی به اطلاعات دسترسی پیدا کنه, ممکنه باعث حمله کوچک Denial of Service (DoS) مبتنی بر اپلیکیشن بشه. در صورتی که مهاجم بتونه حمله رو پخش کنه، ممکنه منجر به حمله DDoS بشه.

23. بایپس روند بیزینسی (Business Flow Bypass) اپلیکیشن ها شامل روند هایی هستند که با ریدایرکت و انتقال صفحه کنترل می شوند. به عنوان مثال، پس از لاگین موفقیت امیز، اپلیکیشن کاربرو به صفحه انتقال پول منتقل می کنه. در طی این نقل و انتقالات, session کاربر توسط یک session کوکی یا مکانیسم دیگه ای حفظ می شود. در خیلی از موارد، این روند رو میشه بایپس کرد که میتونه منجر به یک وضعیت خطا (error condition) یا نشت اطلاعات(information leakage) بشه. این نشت میتونه به attacker کمک کنه تا اطلاعات حیاتی Back-end رو شناسایی کنه. اگر این روند در حال کنترل باشه و اطلاعات حیاتی بده میشه در موارد و سناریوهای مختلف اکسپلویتش کرد

چطور این نقص business logic رو تست کنیم:

ریکوئست و ریسپانس هارو ببینید

متود POST/GET ریکوئست ها نوعی پارامتر زوج name-value یا JSON ,XML یا Cookies دارن. باید name و value پارامتر انالیز بشه

فانکشنالیتی های بیزینسی رو که در مراحل خاصی هستند شناسایی کنید (مثل سبد خرید یا انتقال پول)

تمام مراحل رو به دقت انالیز کنید و به دنبال پارامترهای احتمالی باشید که توسط اپلیکیشن با استفاده از مقادیر پنهان یا از طریق جاوا اسکریپت اضافه می شوند.

این پارامترها رو میشه از طریق یک پروکسی مثل برپ سوییت در حین انجام تراکنش دستکاری کرد. این روند رو مختل می کنه و می تونه برخی از محدودیت های بیزینسی(business constraints) رو دور بزنه.

24. استخراج هویت یا پروفایل

هویت کاربر یکی از مهم ترین پارامترها در اپلیکیشن های احراز هویت شده(authenticated) است. هویت کاربران با استفاده از session یا اشکال دیگه توکن ها نگهداری میشود. برنامه های غیر ایمن به attacker این امکان رو میده تا پارامترهای توکن رو از سمت کلاینت شناسایی کنه و در بعضی موارد در سمت سرور session نیز به دقت نگهداری نمیشه. این سناریو فرصت بالقوه ای رو برای سوء استفاده و اکسپلویتیشن گسترده از سیستم میده. این توکن فقط از یک عدد متوالی یا یک یوزرنیم قابل حدس زدن استفاده می کنه.

چگونه این business logic رو تست کنیم:

ریکوئست و ریسپانس هارو ببینید

متود POST/GET ریکوئست ها نوعی پارامتر زوج name-value یا JSON ,XML یا Cookies دارن. باید name و value پارامتر انالیز بشه

به دنبال پارامترهایی باشید که پروفایل رو کنترل می کنه.

هنگامی که این پارامترهای تارگت شناسایی شدند، میشه توکن هارو رمزگشایی، حدس یا مهندسی معکوس کرد. اگر توکن ها حدس زده و بازتولید یا بازسازی بشند - پایان بازی!

25. دسترسی به فایل یا URL غیرمجاز و هویت استخراج اطلاعات بیزینس

اپلیکیشن های بیزینسی حاوی اطلاعات مهمی در قابلیت های خودشون, در فایل‌هایی که اکسپورت(export) میشن و یا قابلیت تبدیل فرمتشونو دارند هستند. کاربر میتونه داده های خودشو با فرمت مورد نظرش (PDF، XLS یا CSV) اکسپورت کنه و دانلودش کنه. اگر این فانکشنالیتی به دقت اجرا نشه، میتونه باعث asset leakage بشه. یک attacker میتونه این اطلاعاتو از لایه اپلیکیشن استخراج کنه. این یکی از رایج ترین سهو انگاری هایی هست که به راحتی قابل اکسپلویت هست. این فایل هارو میشه مستقیما از URL ها یا با استفاده از بعضی پارامترهای داخلی fetch کرد یا بهشون رسید.

چگونه این business logic رو تست کنیم:

ریکوئست و ریسپانس هارو ببینید

متود POST/GET ریکوئست ها نوعی پارامتر زوج name-value یا JSON ,XML یا Cookies دارن. باید name و value پارامتر انالیز بشه

فانکشنالیتی های فراخوانی فایل رو بر اساس نام پارامترها مانند file, doc, dir و… شناسایی کنید. این پارامترها اسیب‌پذیری‌های دسترسی غیرمجاز به فایل‌هارو ممکن میکنه.

وقتی که یک پارامتر تارگت شناسایی شد, شروع به انجام بروت فورس ابتدایی یا حدس برای رسیدن به فایل های کاربر دیگه ای از سرور کنید.

26. null pyloads

27. در تغییر رمز عبور سعی کنید رمز عبور فعلی رو حذف کنید